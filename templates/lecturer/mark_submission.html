{% extends "base.html" %}

{% block title %}Mark Submission{% endblock %}

{% block sidebar %}
<a class="nav-link" href="{{ url_for('lecturer_dashboard') }}">
    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
</a>
<a class="nav-link active" href="{{ url_for('lecturer_courses') }}">
    <i class="fas fa-book me-2"></i>My Courses
</a>
{% endblock %}

{% block content %}
<div class="mb-4">
    <h2><i class="fas fa-edit me-2"></i>Mark Submission</h2>
    <p class="text-muted mb-0">
        <strong>Student:</strong> {{ submission.student_name }} ({{ submission.student_email }})<br>
        <strong>Quiz:</strong> {{ quiz.title }}<br>
        <strong>Submitted:</strong> {{ submission.submitted_at.strftime('%Y-%m-%d %H:%M') }}
    </p>
</div>

<!-- Score Summary -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h6>Auto Score</h6>
                <h3>{{ submission.auto_score|default(0) }} pts</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <h6>Manual Score</h6>
                <h3 id="manualScoreDisplay">{{ submission.manual_score|default(0) }} pts</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h6>Total Score</h6>
                <h3 id="totalScoreDisplay">{{ submission.score }} pts</h3>
                <small id="percentageDisplay">({{ "%.1f"|format((submission.score / total_points * 100) if total_points > 0 else 0) }}%)</small>
            </div>
        </div>
    </div>
</div>

<form id="markingForm" method="POST">
    {% for i, question in enumerate(questions) %}
    <div class="card mb-3">
        <div class="card-header {% if question.type == 'open_ended' %}bg-warning bg-opacity-10{% endif %}">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    Question {{ i + 1 }}
                    {% if question.type == 'open_ended' %}
                        <span class="badge bg-warning">Requires Manual Marking</span>
                    {% else %}
                        <span class="badge bg-info">Auto-Marked</span>
                    {% endif %}
                </h5>
                <span class="badge bg-primary">{{ question.points|default(10) }} points</span>
            </div>
        </div>
        <div class="card-body">
            <h6 class="mb-3">{{ question.question }}</h6>
            
            {% if question.type == 'open_ended' %}
                <!-- Open-ended question marking -->
                <div class="mb-3">
                    <label class="form-label"><strong>Student's Answer:</strong></label>
                    <div class="alert alert-light border">
                        {{ answers[i|string]|default('No answer provided') }}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label"><strong>Points Awarded:</strong></label>
                        <input type="number" class="form-control manual-points" 
                               name="question_{{ i }}_points" 
                               min="0" max="{{ question.points|default(10) }}" 
                               value="{{ manual_marks.get(i|string, {}).get('points', 0) }}"
                               onchange="updateTotalScore()">
                        <small class="text-muted">Max: {{ question.points|default(10) }} points</small>
                    </div>
                </div>
                
                <div class="mt-3">
                    <label class="form-label"><strong>Feedback (Optional):</strong></label>
                    <textarea class="form-control" name="question_{{ i }}_feedback" 
                              rows="2" placeholder="Provide feedback to the student...">{{ manual_marks.get(i|string, {}).get('feedback', '') }}</textarea>
                </div>
            {% else %}
                <!-- Auto-marked question display -->
                <div class="mb-3">
                    <strong>Options:</strong>
                    <ul class="list-group mt-2">
                        {% for option in question.options %}
                        {% set is_correct = (question.correct is iterable and question.correct is not string and loop.index0 in question.correct) or loop.index0 == question.correct %}
                        {% set is_student_answer = (answers[i|string] is iterable and answers[i|string] is not string and loop.index0 in answers[i|string]) or answers[i|string] == loop.index0 %}
                        <li class="list-group-item {% if is_correct %}list-group-item-success{% endif %} {% if is_student_answer %}border-primary border-3{% endif %}">
                            {{ option }}
                            {% if is_correct %}
                                <span class="badge bg-success float-end">Correct Answer</span>
                            {% endif %}
                            {% if is_student_answer %}
                                <span class="badge bg-primary float-end me-2">Student's Answer</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                
                {% set student_ans = answers[i|string] %}
                {% set correct_ans = question.correct %}
                {% if correct_ans is iterable and correct_ans is not string %}
                    {% set is_correct = (student_ans is iterable and student_ans is not string and student_ans|sort == correct_ans|sort) %}
                {% else %}
                    {% set is_correct = (student_ans == correct_ans or (student_ans is iterable and student_ans is not string and student_ans|length == 1 and student_ans[0] == correct_ans)) %}
                {% endif %}
                
                <div class="alert {% if is_correct %}alert-success{% else %}alert-danger{% endif %}">
                    <i class="fas fa-{% if is_correct %}check-circle{% else %}times-circle{% endif %} me-2"></i>
                    <strong>Result:</strong> 
                    {% if is_correct %}
                        Correct! (+{{ question.points|default(10) }} points)
                    {% else %}
                        Incorrect (0 points)
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
    
    <!-- General Feedback -->
    <div class="card mb-3">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-comment me-2"></i>General Feedback</h5>
        </div>
        <div class="card-body">
            <textarea class="form-control" name="general_feedback" rows="4" 
                      placeholder="Provide overall feedback to the student...">{{ submission.feedback|default('') }}</textarea>
        </div>
    </div>
    
    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-success btn-lg">
            <i class="fas fa-save me-2"></i>Save Marking
        </button>
        <a href="{{ url_for('lecturer_quiz_submissions', quiz_id=quiz.id) }}" class="btn btn-secondary btn-lg">
            Cancel
        </a>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
function updateTotalScore() {
    const autoScore = {{ submission.auto_score|default(0) }};
    let manualScore = 0;
    
    document.querySelectorAll('.manual-points').forEach(input => {
        manualScore += parseFloat(input.value) || 0;
    });
    
    const totalScore = autoScore + manualScore;
    const totalPoints = {{ total_points }};
    const percentage = (totalScore / totalPoints * 100).toFixed(1);
    
    document.getElementById('manualScoreDisplay').textContent = manualScore + ' pts';
    document.getElementById('totalScoreDisplay').textContent = totalScore + ' pts';
    document.getElementById('percentageDisplay').textContent = `(${percentage}%)`;
}

document.getElementById('markingForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    
    formData.forEach((value, key) => {
        data[key] = value;
    });
    
    try {
        const response = await fetch('{{ url_for("lecturer_mark_submission", submission_id=submission.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            alert('Marking saved successfully!');
            window.location.href = '{{ url_for("lecturer_quiz_submissions", quiz_id=quiz.id) }}';
        } else {
            alert('Error saving marking. Please try again.');
        }
    } catch (error) {
        alert('Error saving marking. Please try again.');
    }
});

// Initialize total score display
updateTotalScore();
</script>
{% endblock %}
