{% extends "base.html" %}

{% block title %}AI Chatbot{% endblock %}

{% block sidebar %}
<a class="nav-link" href="{{ url_for('student_dashboard') }}">
    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
</a>
<a class="nav-link" href="{{ url_for('student_departments') }}">
    <i class="fas fa-building me-2"></i>Select Department
</a>
<a class="nav-link" href="{{ url_for('student_courses') }}">
    <i class="fas fa-book me-2"></i>My Courses
</a>
<a class="nav-link active" href="{{ url_for('student_chatbot') }}">
    <i class="fas fa-robot me-2"></i>AI Chatbot
</a>
{% endblock %}

{% block extra_css %}
<style>
#chatContainer {
    height: 600px;
    overflow-y: auto;
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
}

.message {
    margin-bottom: 15px;
    display: flex;
    align-items: flex-start;
}

.message.user {
    justify-content: flex-end;
}

.message.bot {
    justify-content: flex-start;
}

.message-content {
    max-width: 70%;
    padding: 12px 18px;
    border-radius: 18px;
    word-wrap: break-word;
}

.message.user .message-content {
    background: linear-gradient(135deg, #4f46e5, #7c3aed);
    color: white;
}

.message.bot .message-content {
    background: white;
    color: #1f2937;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.message-icon {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 10px;
    font-size: 18px;
}

.message.user .message-icon {
    background: linear-gradient(135deg, #4f46e5, #7c3aed);
    color: white;
}

.message.bot .message-icon {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.typing-indicator {
    display: none;
    padding: 10px;
}

.typing-indicator span {
    height: 10px;
    width: 10px;
    background-color: #90a4ae;
    border-radius: 50%;
    display: inline-block;
    margin: 0 2px;
    animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
    }
    30% {
        transform: translateY(-10px);
    }
}
</style>
{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="fas fa-robot me-2"></i>AI Learning Assistant</h2>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white;">
                <h5 class="mb-0"><i class="fas fa-comments me-2"></i>Chat with AI</h5>
            </div>
            <div class="card-body p-0">
                <div id="chatContainer">
                    <div class="message bot">
                        <div class="message-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            Hello! I'm your AI learning assistant. I can help you with questions about your course materials. 
                            Feel free to ask me anything!
                        </div>
                    </div>
                </div>
                
                <div class="typing-indicator" id="typingIndicator">
                    <div class="message bot">
                        <div class="message-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <form id="chatForm">
                    <div class="input-group">
                        <input type="text" id="messageInput" class="form-control" 
                               placeholder="Type your message..." required>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-body">
                <h6><i class="fas fa-lightbulb me-2"></i>Tips for better responses:</h6>
                <ul class="mb-0">
                    <li>Ask specific questions about your course materials</li>
                    <li>Be clear and concise in your questions</li>
                    <li>The AI learns from uploaded PDFs and online resources</li>
                    <li>You can ask for explanations, summaries, or clarifications</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const chatContainer = document.getElementById('chatContainer');
const chatForm = document.getElementById('chatForm');
const messageInput = document.getElementById('messageInput');
const typingIndicator = document.getElementById('typingIndicator');

function scrollToBottom() {
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function addMessage(text, isUser, useTypingEffect = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
    
    const iconDiv = document.createElement('div');
    iconDiv.className = 'message-icon';
    iconDiv.innerHTML = `<i class="fas fa-${isUser ? 'user' : 'robot'}"></i>`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    if (isUser) {
        messageDiv.appendChild(contentDiv);
        messageDiv.appendChild(iconDiv);
    } else {
        messageDiv.appendChild(iconDiv);
        messageDiv.appendChild(contentDiv);
    }
    
    chatContainer.appendChild(messageDiv);
    scrollToBottom();
    
    // Apply typing effect for bot messages if requested
    if (!isUser && useTypingEffect) {
        typeText(contentDiv, text);
    } else {
        contentDiv.textContent = text;
    }
}

function typeText(element, text, speed = 15) {
    let index = 0;
    element.textContent = '';
    
    function typeChar() {
        if (index < text.length) {
            element.textContent += text.charAt(index);
            index++;
            scrollToBottom();
            setTimeout(typeChar, speed);
        }
    }
    
    typeChar();
}

chatForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const message = messageInput.value.trim();
    if (!message) return;
    
    // Add user message
    addMessage(message, true);
    messageInput.value = '';
    
    // Show typing indicator
    typingIndicator.style.display = 'block';
    scrollToBottom();
    
    try {
        const response = await fetch('{{ url_for("chatbot_message") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: message })
        });
        
        const data = await response.json();
        
        // Hide typing indicator
        typingIndicator.style.display = 'none';
        
        // Add bot response with typing effect
        addMessage(data.response, false, true);
    } catch (error) {
        typingIndicator.style.display = 'none';
        addMessage('Sorry, I encountered an error. Please try again.', false);
    }
});

// Focus on input on load
messageInput.focus();
</script>
{% endblock %}
