{% extends "base.html" %}

{% block title %}AI Chatbot{% endblock %}

{% block sidebar %}
<a class="nav-link" href="{{ url_for('student_dashboard') }}">
    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
</a>
<a class="nav-link" href="{{ url_for('student_departments') }}">
    <i class="fas fa-building me-2"></i>Select Department
</a>
<a class="nav-link" href="{{ url_for('student_courses') }}">
    <i class="fas fa-book me-2"></i>My Courses
</a>
<a class="nav-link active" href="{{ url_for('student_chatbot') }}">
    <i class="fas fa-robot me-2"></i>AI Chatbot
</a>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<style>
#chatContainer {
    height: 600px;
    overflow-y: auto;
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
}

.message {
    margin-bottom: 15px;
    display: flex;
    align-items: flex-start;
}

.message.user {
    justify-content: flex-end;
}

.message.bot {
    justify-content: flex-start;
}

.message-content {
    max-width: 70%;
    padding: 12px 18px;
    border-radius: 18px;
    word-wrap: break-word;
    white-space: pre-wrap;
}

.message.user .message-content {
    background: linear-gradient(135deg, #4f46e5, #7c3aed);
    color: white;
}

.message.bot .message-content {
    background: white;
    color: #1f2937;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    line-height: 1.6;
}

.message.bot .message-content p {
    margin-bottom: 10px;
}

.message.bot .message-content strong {
    color: #4f46e5;
    font-weight: 600;
}

.message.bot .message-content code {
    background: #f3f4f6;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    color: #dc2626;
}

.message.bot .message-content pre {
    background: #1f2937;
    padding: 15px;
    border-radius: 8px;
    overflow-x: auto;
    margin: 10px 0;
}

.message.bot .message-content pre code {
    background: transparent;
    padding: 0;
    color: #e5e7eb;
    font-size: 0.9em;
}

.code-block-header {
    background: #374151;
    color: #9ca3af;
    padding: 8px 12px;
    font-size: 0.85em;
}

.copy-code-btn {
    background: #4f46e5;
    color: white;
    border: none;
    padding: 4px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8em;
}

.message-icon {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 10px;
    font-size: 18px;
    flex-shrink: 0;
}

.message.user .message-icon {
    background: linear-gradient(135deg, #4f46e5, #7c3aed);
    color: white;
}

.message.bot .message-icon {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.typing-indicator {
    display: none;
    padding: 10px;
}

.typing-indicator span {
    height: 10px;
    width: 10px;
    background-color: #90a4ae;
    border-radius: 50%;
    display: inline-block;
    margin: 0 2px;
    animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
    }
    30% {
        transform: translateY(-10px);
    }
}

#stopButton {
    display: none;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.message.bot .message-content ul,
.message.bot .message-content ol {
    margin-left: 20px;
    margin-bottom: 10px;
}
</style>
{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="fas fa-robot me-2"></i>AI Learning Assistant</h2>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white;">
                <h5 class="mb-0"><i class="fas fa-comments me-2"></i>Chat with AI</h5>
            </div>
            <div class="card-body p-0">
                <div id="chatContainer">
                    <div class="message bot">
                        <div class="message-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            Hello! I'm your AI learning assistant. I can help you with questions about your course materials. 
                            Feel free to ask me anything!
                        </div>
                    </div>
                </div>
                
                <div class="typing-indicator" id="typingIndicator">
                    <div class="message bot">
                        <div class="message-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <form id="chatForm">
                    <div class="input-group">
                        <input type="text" id="messageInput" class="form-control" 
                               placeholder="Type your message..." required>
                        <button type="submit" class="btn btn-primary" id="sendButton">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                        <button type="button" class="btn btn-danger" id="stopButton">
                            <i class="fas fa-stop"></i> Stop
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-body">
                <h6><i class="fas fa-lightbulb me-2"></i>Tips for better responses:</h6>
                <ul class="mb-0">
                    <li>Ask specific questions about your course materials</li>
                    <li>Be clear and concise in your questions</li>
                    <li>The AI learns from uploaded PDFs and online resources</li>
                    <li>You can ask for explanations, summaries, or clarifications</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
const chatContainer = document.getElementById('chatContainer');
const chatForm = document.getElementById('chatForm');
const messageInput = document.getElementById('messageInput');
const typingIndicator = document.getElementById('typingIndicator');
const sendButton = document.getElementById('sendButton');
const stopButton = document.getElementById('stopButton');

let isTyping = false;
let stopTyping = false;
let chatHistory = [];

// Load chat history on page load
window.addEventListener('load', loadChatHistory);

async function loadChatHistory() {
    try {
        const response = await fetch('{{ url_for("get_chat_history") }}');
        const data = await response.json();
        
        if (data.history && data.history.length > 0) {
            chatHistory = data.history;
            // Display last 5 messages
            data.history.slice(-5).forEach(chat => {
                addMessage(chat.message, true, false);
                addMessage(chat.response, false, false);
            });
        }
    } catch (error) {
        console.log('No previous chat history');
    }
}

function scrollToBottom() {
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function formatResponse(text) {
    let formatted = text;
    
    // Convert **bold** to <strong>
    formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    
    // Convert code blocks
    formatted = formatted.replace(/```([\s\S]*?)```/g, function(match, code) {
        const lines = code.trim().split('\n');
        const language = lines[0].trim();
        const codeContent = lines.slice(1).join('\n');
        
        return `<div class="code-block-wrapper">
            <div class="code-block-header">
                <span>${language || 'code'}</span>
                <button class="copy-code-btn" onclick="copyCode(this)"><i class="fas fa-copy"></i> Copy</button>
            </div>
            <pre><code class="language-${language}">${escapeHtml(codeContent)}</code></pre>
        </div>`;
    });
    
    // Convert inline `code`
    formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    // Convert numbered lists
    formatted = formatted.replace(/^(\d+\.)\s+(.+)$/gm, '<li>$2</li>');
    if (formatted.includes('<li>')) {
        formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ol>$1</ol>');
    }
    
    // Convert bullet points
    formatted = formatted.replace(/^[â€¢\-*]\s+(.+)$/gm, '<li>$1</li>');
    if (formatted.includes('<li>') && !formatted.includes('<ol>')) {
        formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
    }
    
    // Convert double line breaks to paragraphs
    const paragraphs = formatted.split('\n\n');
    formatted = paragraphs.map(p => {
        if (!p.trim().startsWith('<')) {
            return `<p>${p.trim()}</p>`;
        }
        return p;
    }).join('');
    
    return formatted;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function copyCode(button) {
    const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
    const text = codeBlock.textContent;
    
    navigator.clipboard.writeText(text).then(() => {
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Copied!';
        setTimeout(() => {
            button.innerHTML = originalText;
        }, 2000);
    });
}

function addMessage(text, isUser, useTypingEffect = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
    
    const iconDiv = document.createElement('div');
    iconDiv.className = 'message-icon';
    iconDiv.innerHTML = `<i class="fas fa-${isUser ? 'user' : 'robot'}"></i>`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    if (isUser) {
        messageDiv.appendChild(contentDiv);
        messageDiv.appendChild(iconDiv);
        contentDiv.textContent = text;
    } else {
        messageDiv.appendChild(iconDiv);
        messageDiv.appendChild(contentDiv);
    }
    
    chatContainer.appendChild(messageDiv);
    scrollToBottom();
    
    // Apply typing effect for bot messages if requested
    if (!isUser && useTypingEffect) {
        return typeText(contentDiv, text);
    } else if (!isUser) {
        contentDiv.innerHTML = formatResponse(text);
        // Apply syntax highlighting
        contentDiv.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
        });
    }
    
    return Promise.resolve();
}

function typeText(element, text, speed = 20) {
    return new Promise((resolve) => {
        let index = 0;
        element.innerHTML = '';
        isTyping = true;
        stopTyping = false;
        
        // Show stop button
        stopButton.style.display = 'inline-block';
        sendButton.disabled = true;
        
        function typeChar() {
            if (stopTyping || index >= text.length) {
                isTyping = false;
                stopButton.style.display = 'none';
                sendButton.disabled = false;
                
                // Format the complete text
                element.innerHTML = formatResponse(text);
                
                // Apply syntax highlighting
                element.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
                
                scrollToBottom();
                resolve();
                return;
            }
            
            // Type character by character
            const currentText = text.substring(0, index + 1);
            element.textContent = currentText;
            index++;
            scrollToBottom();
            setTimeout(typeChar, speed);
        }
        
        typeChar();
    });
}

stopButton.addEventListener('click', function() {
    stopTyping = true;
});

chatForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const message = messageInput.value.trim();
    if (!message || isTyping) return;
    
    // Add user message
    addMessage(message, true);
    chatHistory.push({ message: message, isUser: true });
    messageInput.value = '';
    
    // Show typing indicator
    typingIndicator.style.display = 'block';
    scrollToBottom();
    
    // Disable send button
    sendButton.disabled = true;
    
    try {
        // Build context from recent chat history
        const recentHistory = chatHistory.slice(-6).map(chat => {
            return chat.isUser ? `User: ${chat.message}` : `Assistant: ${chat.response}`;
        }).join('\n');
        
        const response = await fetch('{{ url_for("chatbot_message") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                message: message,
                history: recentHistory
            })
        });
        
        const data = await response.json();
        
        // Hide typing indicator
        typingIndicator.style.display = 'none';
        
        // Add bot response with typing effect
        await addMessage(data.response, false, true);
        chatHistory.push({ message: data.response, isUser: false, response: data.response });
        
    } catch (error) {
        typingIndicator.style.display = 'none';
        addMessage('Sorry, I encountered an error. Please try again.', false);
        sendButton.disabled = false;
    }
});

// Focus on input on load
messageInput.focus();
</script>
{% endblock %}
